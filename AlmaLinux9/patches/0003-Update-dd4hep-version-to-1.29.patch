From 46a528b4615f1eae897ce2e107794fb8c5667d86 Mon Sep 17 00:00:00 2001
From: Karol Krizka <kkrizka@gmail.com>
Date: Wed, 10 Jul 2024 07:25:35 +0100
Subject: [PATCH 3/3] Update dd4hep version to 1.29.

---
 .../repos/builtin/packages/dd4hep/package.py  | 73 ++-----------------
 1 file changed, 5 insertions(+), 68 deletions(-)

diff --git a/var/spack/repos/builtin/packages/dd4hep/package.py b/var/spack/repos/builtin/packages/dd4hep/package.py
index 25647bcc21..443cb81d83 100644
--- a/var/spack/repos/builtin/packages/dd4hep/package.py
+++ b/var/spack/repos/builtin/packages/dd4hep/package.py
@@ -26,6 +26,7 @@ class Dd4hep(CMakePackage):
     license("LGPL-3.0-or-later")
 
     version("master", branch="master")
+    version("1.29", sha256="435d25a7ef093d8bf660f288b5a89b98556b4c1c293c55b93bf641fb4cba77e9")
     version("1.28", sha256="b28d671eda0154073873a044a384486e66f1f200065deca99537aa84f07328ad")
     version("1.27.2", sha256="09d8acd743d010274562b856d39e2a88aeaf89cf287a4148f52223b0cd960ab2")
     version("1.27.1", sha256="e66ae726c0a9a55e5603024a7f8a48ffbc5613ea36e5f892e9a90d87833f92e0")
@@ -44,76 +45,9 @@ class Dd4hep(CMakePackage):
     version("1.18", sha256="1e909a42b969dfd966224fa8ab1eca5aa05136baf3c00a140f2f6d812b497152")
     version("1.17", sha256="036a9908aaf1e13eaf5f2f43b6f5f4a8bdda8183ddc5befa77a4448dbb485826")
     version("1.16.1", sha256="c8b1312aa88283986f89cc008d317b3476027fd146fdb586f9f1fbbb47763f1a")
-    # versions older than 1.16.1 are no longer supported
-    # (they need several patches like https://github.com/AIDASoft/DD4hep/pull/796)
-    version(
-        "1.16",
-        sha256="ea9755cd255cf1b058e0e3cd743101ca9ca5ff79f4c60be89f9ba72b1ae5ec69",
-        deprecated=True,
-    )
-    version(
-        "1.15",
-        sha256="992a24bd4b3dfaffecec9d1c09e8cde2c7f89d38756879a47b23208242f4e352",
-        deprecated=True,
-    )
-    version(
-        "1.14.1",
-        sha256="5b5742f1e23c2b36d3174cca95f810ce909c0eb66f3d6d7acb0ba657819e6717",
-        deprecated=True,
-    )
-    version(
-        "1.14",
-        sha256="b603aa3c0db8dda392253aa71fa4a0f0c3c9715d47df0b895d45c1e8849f4895",
-        deprecated=True,
-    )
-    version(
-        "1.13.1",
-        sha256="83fa70cd74ce93b2f52f098388dff58d179f05ace5b50aea3f408bb8abf7cb73",
-        deprecated=True,
-    )
-    version(
-        "1.13",
-        sha256="0b1f9d902ebe21a9178c1e41204c066b29f68c8836fd1d03a9ce979811ddb295",
-        deprecated=True,
-    )
-    version(
-        "1.12.1",
-        sha256="85e8c775ec03c499ce10911e228342e757c81ce9ef2a9195cb253b85175a2e93",
-        deprecated=True,
-    )
-    # these version won't build with +ddcad as the subpackage doesn't exit yet
-    version(
-        "1.12",
-        sha256="133a1fb8ce0466d2482f3ebb03e60b3bebb9b2d3e33d14ba15c8fbb91706b398",
-        deprecated=True,
-    )
-    version(
-        "1.11.2",
-        sha256="96a53dd26cb8df11c6dae54669fbc9cc3c90dd47c67e07b24be9a1341c95abc4",
-        deprecated=True,
-    )
-    version(
-        "1.11.1",
-        sha256="d7902dd7f6744bbda92f6e303ad5a3410eec4a0d2195cdc86f6c1167e72893f0",
-        deprecated=True,
-    )
-    version(
-        "1.11",
-        sha256="25643296f15f9d11ad4ad550b7c3b92e8974fc56f1ee8e4455501010789ae7b6",
-        deprecated=True,
-    )
-    version(
-        "1.10",
-        sha256="1d6b5d1c368dc8bcedd9c61b7c7e1a44bad427f8bd34932516aff47c88a31d95",
-        deprecated=True,
-    )
 
     generator("ninja")
 
-    # Workarounds for various TBB issues in DD4hep v1.11
-    # See https://github.com/AIDASoft/DD4hep/pull/613 .
-    patch("tbb-workarounds.patch", when="@1.11")
-    patch("tbb2.patch", when="@1.12.1")
     # Workaround for failing build file generation in some cases
     # See https://github.com/spack/spack/issues/24232
     patch("cmake_language.patch", when="@:1.17")
@@ -161,10 +95,13 @@ class Dd4hep(CMakePackage):
     depends_on("boost +iostreams", when="+ddg4")
     depends_on("boost +system +filesystem", when="%gcc@:7")
     depends_on("root @6.08: +gdml +math +python")
+    depends_on("root @6.12.2: +root7", when="@1.26:")  # DDCoreGraphics needs ROOT::ROOTHistDraw
     with when("+ddeve"):
         depends_on("root @6.08: +x +opengl")
         depends_on("root @:6.27", when="@:1.23")
         conflicts("^root ~webgui", when="^root@6.28:")
+        # For DD4hep >= 1.24, DDEve_Interface needs ROOT::ROOTGeomViewer only if ROOT >= 6.27
+        requires("^root +root7 +webgui", when="@1.24: ^root @6.27:")
     depends_on("root @6.08: +gdml +math +python +x +opengl", when="+utilityapps")
 
     extends("python")
@@ -189,7 +126,7 @@ class Dd4hep(CMakePackage):
     # See https://github.com/AIDASoft/DD4hep/pull/771 and https://github.com/AIDASoft/DD4hep/pull/876
     conflicts(
         "^cmake@3.16:3.17.2",
-        when="@1.15:1.18",
+        when="@:1.18",
         msg="cmake version with buggy FindPython breaks dd4hep cmake config",
     )
     conflicts("~ddrec+dddetectors", msg="Need to enable +ddrec to build +dddetectors.")
-- 
2.45.2

